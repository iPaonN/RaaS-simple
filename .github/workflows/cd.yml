name: Deploy Discord Bot (Docker)

on:
  push:
    branches: [112dev]
  workflow_run:
    workflows: ["CI - Build and Push Docker Image"]
    types:
      - completed
    branches: [112dev]

jobs:
  deploy:
    runs-on: self-hosted
    # Only run if CI workflow succeeded or if manually pushed
    if: ${{ github.event_name == 'push' || github.event.workflow_run.conclusion == 'success' }}
    environment: secrets

    env:
      CONTAINER_NAME: ${{ format('femrouter-bot-{0}', github.ref_name) }}
      DEPLOY_DIR: ${{ format('/opt/femrouter/{0}', github.ref_name) }}
      ENV_FILE: ${{ format('/opt/femrouter/{0}/.env', github.ref_name) }}
      LOG_DIR: ${{ format('/opt/femrouter/{0}/logs', github.ref_name) }}
    
    steps:
      - name: Log in to Docker Hub
        env:
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          echo "${DOCKERHUB_TOKEN}" | docker login docker.io -u "${DOCKERHUB_USERNAME}" --password-stdin

      - name: Pull latest image
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          docker pull "${DOCKERHUB_USERNAME}/femrouter:latest"

      - name: Create/Update .env file
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          DEV_GUILD_ID: ${{ secrets.DEV_GUILD_ID }}
        run: |
          mkdir -p "${DEPLOY_DIR}"
          echo "DISCORD_TOKEN=${DISCORD_TOKEN}" > "${ENV_FILE}"
          echo "DEV_GUILD_ID=${DEV_GUILD_ID}" >> "${ENV_FILE}"
          echo "PREFIX=!" >> "${ENV_FILE}"
          echo "LOG_LEVEL=INFO" >> "${ENV_FILE}"
      
      - name: Verify .env file was created
        run: |
          echo "--- .env file check ---"
          ls -la "${ENV_FILE}"
          FILE_BYTES=$(wc -c < "${ENV_FILE}")
          FILE_LINES=$(wc -l < "${ENV_FILE}")
          echo "File size: ${FILE_BYTES} bytes"
          echo "Lines in file: ${FILE_LINES}"

      - name: Stop and remove old container
        run: |
          docker stop "${CONTAINER_NAME}" || true
          docker rm "${CONTAINER_NAME}" || true

      - name: Run new container
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          mkdir -p "${LOG_DIR}"
          docker run -d \
            --name "${CONTAINER_NAME}" \
            --restart unless-stopped \
            --env-file "${ENV_FILE}" \
            -v "${LOG_DIR}":/app/logs \
            "${DOCKERHUB_USERNAME}/femrouter:latest"

      - name: Check container status
        run: |
          sleep 5
          docker ps -a | grep "${CONTAINER_NAME}"
          echo "--- Container Logs ---"
          docker logs "${CONTAINER_NAME}" --tail 50

      - name: Clean up old images
        run: |
          docker image prune -f
