name: Deploy Discord Bot (Docker)

on:
  push:
    branches: [pioneer]
  workflow_run:
    workflows: ["CI - Build and Push Docker Image"]
    types:
      - completed
    branches: [pioneer]

jobs:
  deploy:
    runs-on: self-hosted
    # Only run if CI workflow succeeded or if manually pushed
    if: ${{ github.event_name == 'push' || github.event.workflow_run.conclusion == 'success' }}
    environment: pioneer-deployment
    
    steps:
      - name: Log in to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login docker.io -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Pull latest image
        run: |
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/femrouter:latest

      - name: Create/Update .env file
        run: |
          mkdir -p /opt/femrouter
          echo "DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }}" > /opt/femrouter/.env
          echo "DEV_GUILD_ID=${{ secrets.DEV_GUILD_ID }}" >> /opt/femrouter/.env
          echo "PREFIX=!" >> /opt/femrouter/.env
          echo "LOG_LEVEL=INFO" >> /opt/femrouter/.env
      
      - name: Verify .env file was created
        run: |
          echo "--- .env file check ---"
          ls -la /opt/femrouter/.env
          echo "File size: $(wc -c < /opt/femrouter/.env) bytes"
          echo "Lines in file: $(wc -l < /opt/femrouter/.env)"

      - name: Stop and remove old container
        run: |
          docker stop femrouter-bot || true
          docker rm femrouter-bot || true

      - name: Run new container
        run: |
          docker run -d \
            --name femrouter-bot \
            --restart unless-stopped \
            --env-file /opt/femrouter/.env \
            -v /opt/femrouter/logs:/app/logs \
            ${{ secrets.DOCKERHUB_USERNAME }}/femrouter:latest

      - name: Check container status
        run: |
          sleep 5
          docker ps -a | grep femrouter-bot
          echo "--- Container Logs ---"
          docker logs femrouter-bot --tail 50

      - name: Clean up old images
        run: |
          docker image prune -f
